import socket
import base64
import time


DEFAULT_CREDENTIALS = {
    "ssh": [
        ("root", "root"),
        ("admin", "admin"),
        ("pi", "raspberry"),
        ("user", "user"),
        ("root", "toor")
    ],

    "ftp": [
        ("anonymous", "anonymous@"),
        ("admin", "admin"),
        ("ftp", "ftp")
    ],

    "telnet": [
        ("admin", "admin"),
        ("root", "root"),
        ("user", "user"),
    ],

    "http": [
        ("admin", "admin"),
        ("root", "root"),
        ("admin", "password")
    ]
}


class WeakCredentialChecker:

    def _try_connect(self, ip, port, timeout=3):
        """Returns a connected socket or None."""
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.settimeout(timeout)
            s.connect((ip, port))
            return s
        except:
            return None


    def check_ssh(self, ip, port):
        sock = self._try_connect(ip, port)
        if not sock:
            return {"service": "ssh", "result": "connection_failed"}

        # Try banner read (some IoT SSH leaks info)
        try:
            banner = sock.recv(1024).decode(errors="ignore").strip()
        except:
            banner = ""

        sock.close()

        if banner:
            return {
                "service": "ssh",
                "result": "reachable",
                "banner": banner,
                "note": "SSH credential brute-force not implemented for safety."
            }
        else:
            return {"service": "ssh", "result": "no_banner"}


    def check_ftp(self, ip, port):
        results = []

        for user, pwd in DEFAULT_CREDENTIALS["ftp"]:
            try:
                sock = self._try_connect(ip, port)
                if not sock:
                    continue

                resp = sock.recv(1024).decode(errors="ignore")

                sock.sendall(f"USER {user}\r\n".encode())
                resp_user = sock.recv(1024).decode(errors="ignore")

                sock.sendall(f"PASS {pwd}\r\n".encode())
                resp_pass = sock.recv(2048).decode(errors="ignore")

                sock.close()

                if "230" in resp_pass:  # login success
                    return {
                        "service": "ftp",
                        "weak_credential": (user, pwd),
                        "result": "login_success"
                    }

            except Exception as e:
                continue

        return {"service": "ftp", "result": "no_weak_credentials"}


    def check_telnet(self, ip, port):
        for user, pwd in DEFAULT_CREDENTIALS["telnet"]:
            try:
                sock = self._try_connect(ip, port)
                if not sock:
                    continue

                time.sleep(0.5)
                sock.recv(1024)

                sock.sendall(user.encode() + b"\n")
                time.sleep(0.5)

                sock.sendall(pwd.encode() + b"\n")
                time.sleep(1)

                data = sock.recv(2048).decode(errors="ignore")
                sock.close()

                if ">" in data or "#" in data or "$" in data:
                    return {
                        "service": "telnet",
                        "weak_credential": (user, pwd),
                        "result": "login_success"
                    }

            except:
                continue

        return {"service": "telnet", "result": "no_weak_credentials"}


    def check_http(self, ip, port):
        for user, pwd in DEFAULT_CREDENTIALS["http"]:
            try:
                sock = self._try_connect(ip, port)
                if not sock:
                    continue

                creds = f"{user}:{pwd}".encode()
                token = base64.b64encode(creds).decode()

                http_req = (
                    "GET / HTTP/1.1\r\n"
                    f"Host: {ip}\r\n"
                    f"Authorization: Basic {token}\r\n"
                    "Connection: close\r\n\r\n"
                )

                sock.sendall(http_req.encode())
                resp = sock.recv(4096).decode(errors="ignore")
                sock.close()

                if "200 OK" in resp:
                    return {
                        "service": "http",
                        "weak_credential": (user, pwd),
                        "result": "login_success"
                    }

            except:
                continue

        return {"service": "http", "result": "no_weak_credentials"}


    def check(self, ip, port, service):
        service = service.lower()

        if service == "ssh":
            return self.check_ssh(ip, port)
        if service == "ftp":
            return self.check_ftp(ip, port)
        if service == "telnet":
            return self.check_telnet(ip, port)
        if service in ("http", "http-alt", "https", "https-alt"):
            return self.check_http(ip, port)

        return {"service": service, "result": "not_supported"}
