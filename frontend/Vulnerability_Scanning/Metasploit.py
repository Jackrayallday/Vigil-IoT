from frontend.Vulnerability_Scanning.minimal_nmap_wrapper import NmapScanner
from frontend.Vulnerability_Scanning.weak_credentials import WeakCredentialChecker
import json
import time
import asyncio

#scanner = NmapScanner()
#tcp_results = scanner.minimal_tcp_scan("127.0.0.1")
#udp_results = scanner.minimal_udp_scan("127.0.0.1")

KNOWN_SERVICE_CVES = {
    #tcp services
    "ssh": ["CVE-2018-15473", "CVE-2023-48795"],
    "telnet": ["CVE-2011-4862"],
    "http": ["CVE-2021-41773", "CVE-2019-0211"],
    "https": ["CVE-2023-25690"],
    "rtsp": ["CVE-2021-23995"],
    "mbap": ["CVE-2019-10994"],
    "http-alt": ["CVE-2017-7679", "CVE-2021-42013"],
    "http-proxy": ["CVE-2016-5387"],
    "https-alt": ["CVE-2023-25690"],
    
    
    #udp services
    "domain": ["CVE-2020-25684"],
    "ntp": ["CVE-2019-6446"],
    "snmp": ["CVE-2022-44793"],
    "upnp":["CVE-2020-12695"],
    "zeroconf": ["CVE-2015-7989"],
    "coap": ["CVE-2020-17088"],
    "bacnet": ["CVE-2019-9569"],
}



class ServiceVersionAnalyzer:
	def __init__(self):
        	self.scanner = NmapScanner()
        	self.weak_checker = WeakCredentialChecker()

	#Re-runs Nmap module for tcp protocols to check open ports and attaches CVEs
	def analyze_tcp(self, ip, tcp_results):
		findings = []
		
		#compile only open ports
		for entry in tcp_results:
			if entry.get("state") != "open":
				continue
				
			#collect port number and service name
			service = entry.get("service")
			port = entry.get("port")

			#attach CVEs
			cves = KNOWN_SERVICE_CVES.get(service, [])

			findings.append({
            			"protocol": "tcp",
                		"port": port,
                		"service": service,
                		"potential_cves": cves
			})

		return findings
        
        #Re-runs Nmap module for udp protocols to check open ports and attaches CVEs
	def analyze_udp(self, ip, udp_results):
		findings = []
		
		#compile only open ports
		for entry in udp_results:
			if entry.get("state") != "open":
				continue
				
			#collect port number and service name
			service = entry.get("service")
			port = entry.get("port")
			
			#attach CVEs
			cves = KNOWN_SERVICE_CVES.get(service, [])
			
			findings.append({
				"protocol": "udp",
				"port": port,
				"service": service,
				"potential_cves": cves
			})
			
		return findings
		
	def analyze_weak_credentials(self, ip, all_services):
		if not isinstance(all_services, list):
			print("error: all_services is not a list")
			return []
		return self.weak_checker.scan(ip, all_services)##
		
	def run(self, ip, tcp_results, udp_results):
		tcp_services = self.analyze_tcp(ip, tcp_results)
		udp_services = self.analyze_udp(ip, udp_results)
		
		all_services = tcp_services + udp_services
		
		weak_results = self.analyze_weak_credentials(ip, all_services)
		
		return {
			"tcp_services": tcp_services,
			"udp_services": udp_services,
			"weak_credentials": weak_results
		}

if __name__ == "__main__":
	ip = "127.0.0.1"
	analyzer = ServiceVersionAnalyzer()
	
	scanner = NmapScanner()
	tcp = scanner.minimal_tcp_scan(ip).get(ip, [])
	udp = scanner.minimal_udp_scan(ip).get(ip, [])
	
	#print tcp self check
	print("TCP Analysis")
	tcp_services = analyzer.analyze_tcp(ip, tcp) #to be used in weak credential checking later on
	print(tcp_services)
	
	#print udp self check
	print("UDP Analysis")
	udp_services = analyzer.analyze_udp(ip, udp)
	print(udp_services)
	    
	print ("Weak Credential Check")
	weak_results = analyzer.analyze_weak_credentials(ip, tcp_services + udp_services)
	print(weak_results)
    	
	for r in weak_results:
		print(r)
