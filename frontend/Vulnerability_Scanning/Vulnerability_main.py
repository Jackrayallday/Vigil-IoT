import json
import os

from frontend.Vulnerability_Scanning.minimal_nmap_wrapper import NmapScanner
from frontend.Vulnerability_Scanning.Metasploit import ServiceVersionAnalyzer
from frontend.Vulnerability_Scanning.weak_credentials import WeakCredentialChecker

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
DISCOVERY_FILE = os.path.join(BASE_DIR, "deviceDiscovery", "discovery.json")

#print(f"DEBUG FILE PATH:", DISCOVERY_FILE)

def load_discovered_devices():
	if not os.path.exists(DISCOVERY_FILE):
		print(f"[ERROR] Discovery file not found: {DISCOVERY_FILE}")
		return []
        
    
	try:
		with open(DISCOVERY_FILE, "r") as f:
			data = json.load(f)
		return data.get("devices", [])
        	
	except Exception as e:
		print(f"[ERROR] Could not parse discovery file: {e}")
		return []


def run_scans_on_device(ip, device_info):
    """Runs all scanning modules on a single IP address."""
    results = {
        "ip": ip,
        "hostname": device_info.get("hostname", "unknown"),
        "mac": device_info.get("mac"),
        "vendor": device_info.get("vendor"),
        "scans": {}
    }

    # NMAP SCAN
    nmap = NmapScanner()
    tcp_results = nmap.minimal_tcp_scan(ip)
    udp_results = nmap.minimal_udp_scan(ip)
    results["scans"]["nmap_tcp"] = tcp_results
    results["scans"]["nmap_udp"] = udp_results

    # METASPLOIT MODULE 
    try:
        msf = ServiceVersionAnalyzer()
        results["scans"]["metasploit"] = msf.run(ip, tcp_results, udp_results)
    except Exception as e:
        results["scans"]["metasploit"] = {"error": str(e)}

    # WEAK CREDENTIAL SCANNER
    try:
        weak = WeakCredentialChecker()
        results["scans"]["weak_credentials"] = weak.scan(ip)
    except Exception as e:
        results["scans"]["weak_credentials"] = {"error": str(e)}

    return results


def main():
	devices = load_discovered_devices()
	if not devices:
		print("No devices found.")
		return
        
	for dev in devices:
		print(f"IP={dev.get('ip')}, Hostname={dev.get('hostname')}, MAC={dev.get('mac')}")

	all_results = []

	for dev in devices:
		ip = dev.get("ip")
		if not ip:
			print("Skipping device without IP:", dev)
			continue

		print(f"\nScanning {ip}")
		scan_result = run_scans_on_device(ip, dev)
		all_results.append(scan_result)

	print("\n\n FINAL RESULTS")
	for r in all_results:
		print(json.dumps(r, indent=4))


if __name__ == "__main__":
    main()
