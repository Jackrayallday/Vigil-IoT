import nmap
from pprint import pprint
import socket
import re

COMMON_TCP_PORTS = "22, 23, 80, 443, 554, 502, 8080, 8443, 8000"

COMMON_UDP_PORTS = "53, 67, 68, 123, 161, 1900, 5353, 5683, 47808"

def is_valid_ip(ip):
	return bool(re.match(r"^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$", ip)) and all(0 <= int(part) <= 255 for part in ip.split('.'))

def is_valid_port(port):
	try:
		port = int(port)
		return 1<=port<= 65535
	except ValueError:
		return False
class MinimalNmapWrapper:
	def minimal_tcp_scan(ip, ports = None, use_syn = False):
		ports = ports or COMMON_TCP_PORTS
		
		if not isinstance(ip, str) or not is_valid_ip(ip):
			print(f"Error: Invalid IP address' {ip}'. Must be a valid IPv4 address")
			return {}
		
		if isinstance(ports, str):
			#ports = ports.split(',')
			print(f"Error. Ports must be integers, not string like '{ports}'")
			return {}
		
		if isinstance(ports, int):
			ports = [ports]#[str(ports)]
		
		invalid_ports = [port for port in ports if not (1<= port <= 65535)]#is_valid_port(port)]
			
		if '0' in ports:
			print("Error: Invalid port(s) '0'. Ports must be between 1 and 65535.")
			return {}
		if invalid_ports:
			print(f"Error: Invalid port(s) '{', '.join(map(str, invalid_ports))}'. Ports must be between 1 and 65535.")
			return {}
				
		
		nm = nmap.PortScanner()
		scan_flag = "-sS" if use_syn else "-sT"
		args = f"{scan_flag} -p {','.join(map(str, ports))} -Pn -T2" #-p {ports}
		print("Running nmap:", args, "on", ip)
		
		try:
			nm.scan(hosts = ip, arguments = args)
		except Exception as e:
			print(f"Error scanning {ip}:{e}")
			return {}
			
		results = {}
		for host in nm.all_hosts():
			results[host] = []
			for proto in nm[host].all_protocols():
				for port in sorted(nm[host][proto].keys()):
					p = nm[host][proto][port]
					results[host].append({
						"protocol": proto,
						"port": int(port),
						"state": p.get("state"),
						"service": p.get("name")
					})
		return results
	
	def minimal_udp_scan(ip, ports = None):
		ports = ports or COMMON_UDP_PORTS
		
		if not isinstance(ip, str) or not is_valid_ip(ip):
			print(f"Error: Invalid IP address' {ip}'. Must be a valid IPv4 address.")
			return {}
		
		if isinstance(ports, str):
			#ports = [str(port).strip() for port in ports.split(',')]
			print(f"Erro:Invalid IP address '{ip}'. Must be a valif IP4v address.")
			return {}
			
		if isinstance(ports, int):
			ports = [ports]#[str(ports)]
		
		invalid_ports = [port for port in ports if not (1<= port <= 65535)]#is_valid_port(port)]
			
		if '0' in ports:
			print("Error: Invalid port(s) '0'. Ports must be between 1 and 65535.")
			return {}
		
		
		if invalid_ports:
			print(f"Error: Invalid port(s) '{', '.join(map(str, invalid_ports))}'. Ports must be between 1 and 65535.")
			return {}
		
		nm = nmap.PortScanner()
		scan_flag = "-sU"
		args = f"{scan_flag} -p {','.join(map(str, ports))} -Pn -T2" 
		print("Running nmap:", args, "on", ip)
		try:
			nm.scan(hosts = ip, arguments = args)
		except Exception as e:
			print(f"Error scanning {ip}: {e}")
			return {}
			
		results = {}
		for host in nm.all_hosts():
			results[host] = []
			if 'udp' in nm[host]:
				for port in sorted(nm[host]['udp'].keys()):
					p = nm[host]['udp'][port]
					results[host].append({
						"protocol": 'udp',
						"port": int(port),
						"state": p.get("state"),
						"service": p.get("name")
					})
		return results
	
if __name__ == "__main__":
	target = "127.0.0.1"
	tcp = minimal_tcp_scan(target, ports = "1-1000", use_syn=False)
	pprint(tcp)
	udp = minimal_udp_scan(target, ports = "53, 67, 123")
	pprint (udp)
	
