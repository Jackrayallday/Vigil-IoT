from minimal_nmap_wrapper import NmapScanner

#scanner = NmapScanner()
#tcp_results = scanner.minimal_tcp_scan("127.0.0.1")
#udp_results = scanner.minimal_udp_scan("127.0.0.1")

KNOWN_SERVICE_CVES = {
    #tcp services
    "ssh": ["CVE-2018-15473"],
    "telnet": ["CVE-2011-4862"],
    "http": ["CVE-2021-41773"],
    "https": ["CVE-2023-25690"],
    "rtsp": ["CVE-2021-23995"],
    "mbap": ["CVE-2019-10994"],
    "http-alt": ["CVE-2017-7679", "CVE-2021-42013", "CVE-2017-7679"],
    "http-proxy": ["CVE-2016-5387"],
    "https-alt": ["CVE-2023-25690"],
    
    
    #udp services
    "domain": ["CVE-2015-5722"],
    "ntp": ["CVE-2019-6446"],
    "snmp": ["CVE-2022-44793"],
    "upnp":["CVE-2020-12695"],
    "zeroconf": ["CVE-2015-7989"],
    "coap": ["CVE-2020-17088"],
    "bacnet": ["CVE-2019-9569"],
}



class ServiceVersionAnalyzer:
	def __init__(self):
        	self.scanner = NmapScanner()

	#Re-runs Nmap module for tcp protocols to check open ports and attaches CVEs
	def analyze_tcp(self, ip):
		results = self.scanner.minimal_tcp_scan(ip)
		if ip not in results:
			return []

		findings = []
		#compile only open ports
		for entry in results[ip]:
			if entry["state"] != "open":
				continue
			#collect port number and service name
			service = entry["service"]
			port = entry["port"]

			#attach CVEs
			cves = KNOWN_SERVICE_CVES.get(service, [])

			findings.append({
            			"protocol": "tcp",
                		"port": port,
                		"service": service,
                		"potential_cves": cves
			})

		return findings
        
        #Re-runs Nmap module for udp protocols to check open ports and attaches CVEs
	def analyze_udp(self, ip):
		results = self.scanner.minimal_udp_scan(ip)
		if ip not in results:
			return []
		
		findings = []
		#compile only open ports
		for entry in results[ip]:
			if entry["state"] != "open":
				continue
			#collect port number and service name
			service = entry["service"]
			port = entry["port"]
			
			#attach CVEs
			cves = COMMON_SERVICE_CVES.get(service, [])
			
			findings.append({
				"protocol": "udp",
				"port": port,
				"service": service,
				"potential_cves": cves
			})
			
		return findings
		


if __name__ == "__main__":
    analyzer = ServiceVersionAnalyzer()
    #print tcp self check
    print("TCP Analysis")
    print(analyzer.analyze_tcp("127.0.0.1"))
    #print udp self check
    print("UDP Analysis")
    print(analyzer.analyze_udp("127.0.0.1"))
